#!/usr/bin/env python3
# Copyright 2024 The ChromiumOS Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

"""Build protobuf package."""

import logging
import os
from pathlib import Path
import sys

FILESDIR = Path(__file__).resolve().parent
sys.path.insert(0, str(FILESDIR.parent.parent / "bin"))

import ssh_client  # pylint: disable=wrong-import-position


ARCHIVES = ("%(pn)s-cpp-%(PV)s.tar.gz",)
PATCHES = ("%(pn)s-no-gtest.patch",)


def src_configure(metadata):
    """Configure the source."""
    if os.path.exists("Makefile"):
        logging.info("Makefile exists; skipping ./configure step")
        return

    tc = metadata["toolchain"]
    cmd = [
        "./configure",
        f"--build={tc.cbuild}",
        f"--host={tc.chost}",
        # The prefix path matches what is used at runtime.
        "--prefix=/",
        f"--includedir=/{tc.relincdir}",
        f"--libdir=/{tc.rellibdir}",
        "--cache-file=../config.cache",
    ]
    ssh_client.run(cmd)


def src_compile(metadata):
    """Compile the source."""
    tc = metadata["toolchain"]
    if tc.cbuild == tc.chost:
        ssh_client.emake("protoc", cwd=metadata["S"] / "src")
    else:
        ssh_client.emake("libprotobuf.la", cwd=metadata["S"] / "src")


def src_install(metadata):
    """Install the package."""
    tc = metadata["toolchain"]
    if tc.cbuild == tc.chost:
        # Build needs protoc binary to generate bindings.
        ssh_client.symlink(
            metadata["S"] / "src" / "protoc", ssh_client.BUILD_BINDIR / "protoc"
        )
    else:
        # Target needs protobuf library.
        ssh_client.emake(
            "install-libLTLIBRARIES",
            "install-data",
            f"DESTDIR={tc.sysroot}",
            "lib_LTLIBRARIES=libprotobuf.la",
            cwd=metadata["S"] / "src",
        )
        ssh_client.emake(
            "install-data",
            f"DESTDIR={tc.sysroot}",
        )


ssh_client.build_package(sys.modules[__name__], "wasip1-threads")
